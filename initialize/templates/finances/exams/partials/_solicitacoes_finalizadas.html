{% load static %}

    <div class="col s12" id="solicitacao_finalizada" style="padding: 30px;">
        <table class="bordered pagelengthoption" style="margin-bottom: 10px;">
            <thead style="background-color: #581848; color: white; font-size: 15px">
                <tr>
                    <th data-field="id">Paciente</th>
                    <th data-field="id" style="text-align: center;">Data Coleta</th>
                    <th data-field="id" style="text-align: center;">Inicio do Processo</th>
                    <th data-field="id" style="text-align: center;">Fim do Processo</th>
                    <th data-field="id" style="text-align: center; width: 130px;">Tipo do Exame</th>
                    <th data-field="id" style="text-align: center; width: 130px;">Unidade</th>
                    <th data-field="id" style="text-align: center; width: 130px;">Status Processo</th>
                    <th data-field="name" style="text-align: center; width: 130px;">Ação</th>
                </tr>
            </thead>
            <tbody id="tb_append2">
                {% for k in arr_Solicitacao_Finalizada %}
                <tr id="tr_{{ k.id }}">
                    <td>{{ k.paciente }}</td>
                    <td style="text-align: center;">{{ k.coleta }}</td>
                    <td style="text-align: center;">{{ k.inicioP }}</td>
                    <td style="text-align: center;">{{ k.fimP }}</td>
                    <td style="text-align: center;">{{ k.exame }}</td>
                    <td style="text-align: center;">{{ k.unidade }}</td>
                    <td style="text-align: center;">{{ k.status_p }}</td>
                    <td style="text-align: center;">
                        <a href="#modalFinalizado" class="modal-trigger" data-id_user="{{ k.id }}" onclick="viewUserModalFinalizadas(this)">
                            <button class="btn mb-1 waves-effect waves-light ativ" type="submit" name="action" style="margin-left: 5px; width: 15px;padding: 1;padding-right: 8px; background-color: #f5be4600; padding-left: 15px;">
                                <i class="material-icons right" style="color: #f5bd46da">edit</i>
                            </button> 
                        </a> 
                        <a data-id_user="{{ k.id }}" onclick="ContratoFile(this)" class="btn tooltipped" data-tooltip="Baixar Termo" data-position="top" style="margin-left: 5px; width: 15px;padding: 1;padding-right: 8px; background-color: #f5be4600; padding-left: 15px;">
                            <i class="material-icons right" style="color: #66a366">library_books</i>
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

<script type = "text/javascript" >

function viewUserModalFinalizadas(object) {
    var id_user = $(object).data("id_user");
    $("#anx_file").data("id_user", id_user);

    var formpost = {
        "csrfmiddlewaretoken": $('input[name="csrfmiddlewaretoken"]').val(),
        "id_user": id_user //DICT COM O VALOR DO ID
    };

    fetchRequest("{% url 'SearchModalExams' %}", "POST", "JSON", formpost, function(re) { 
        if (re["response"] == false) {
            alert("Nenhum dado encontrado.");
        } else {
            $("#modalFinancee").show();
            var key = re["message"];
            var dictKeys = {
                "date_age_finalizado": key["agendamento"]["data_agendamento"],
                "hr_age_finalizado": key["agendamento"]["hr_agendamento"],
                "tp_service_finalizado": key["agendamento"]["tipo_servico"],
                "tp_exame_finalizado": key["agendamento"]["tipo_exame"],
                "tp_conv_finalizado": key["agendamento"]["convenio"],
                "doctor_finalizado": key["agendamento"]["doctor"],
                "nurse_finalizado": key["agendamento"]["NomeNurse"],
                "resp_comercial_finalizado": key["agendamento"]["commerce"],
                "id": key["agendamento"]["id"],
                "tel1_finalizado": key["pessoal"]["phone1"],
                "tel2_finalizado": key["pessoal"]["phone2"],
                "namePaciente_finalizado": key["pessoal"]["paciente"],
                "attendance_finalizado": key["pessoal"]["atendimento"],
                "company_finalizado": key["pessoal"]["company"],
                "zipcode_finalizado": key["endereco"]["cep"],
                "addres_finalizado": key["endereco"]["rua"],
                "number_finalizado": key["endereco"]["numero"],
                "complement_finalizado": key["endereco"]["complemento"],
                "district_finalizado": key["endereco"]["bairro"],
                "city_finalizado": key["endereco"]["cidade"],
                "uf_finalizado": key["endereco"]["uf"],
                "obs_finalizado": key["obs"]["obs"],
                "login_finalizado": key["obs"]["login"],
                "senha_finalizado": key["obs"]["senhaC"],
            }

            $.map(dictKeys, function(n, i) {
                $(`#${i}`).val(n);
                var findLabel = $(`#${i}`).closest("div");
                $(findLabel).find("label").attr("class", "active");
            });
            
            $("#anx_file").data("id_user", key["id"]);

        }
    });


    var id_user = $(object).data("id_user");
    var formpost = {
        "csrfmiddlewaretoken": $('input[name="csrfmiddlewaretoken"]').val(),
        "id_user": id_user
    };

    $("#modalFinancee").hide();
    $(object).prop("disabled", true);
    fetchRequest("{% url 'SearchModalExamsFinances' %}", "POST", "JSON", formpost, function(re) {
        $(object).prop("disabled", false);
        if (re["response"] == false) {
            alert("Nenhum dado encontrado."); 
        } else {
            $("#modalFinancee").show();
            var key = re["message"]; 
            var dictKeys = {
                "date_first_finalizado": key["dados"]["date_start"],
                "date_end_finalizado": key["dados"]["date_end"],
                "statusProgresso_finalizado": key["dados"]["status_process_id"],
                
                "cust_alv_finalizado": key["dados"]["val_alvaro"],
                "val_w_lab_finalizado": key["dados"]["val_work"],
                "val_pago_finalizado": key["dados"]["val_pago"],
                "porcentagem_finalizado": key["dados"]["por_paga"],

                "data_r_finalizado": key["dados"]["date_repass"],
                "n_nf_finalizado": key["dados"]["nf"],
            }
            $.map(dictKeys, function (n, i) { 
            $(`#${i}`).val(n);
            var findLabel = $(`#${i}`).closest("div");
            $(findLabel).find("label").attr("class", "active");
            
            if(i == "statusProgresso_finalizado"){
               $(`#${i}`).val(n);
               var valueObject = $("#statusProgresso_finalizado option:selected").text();
               var ob1 = $(`#${i}`).closest("div");
               var ob2 = ob1[0];
               $(ob2).find("input").val(valueObject);
            }
                
            });

            var ap = "";
            var filesResponse = JSON.parse(re["message"]["files"]);
            $.map(filesResponse, function(n, i) {
                ap += `
                  <tr>
                     <td>${n.file.name}</td>
                     <td>${n.file.date_created.pt}</td>
                     <td>${n.description_type}</td>
                     <td style="text-align: center;">
                        <button data-url="${n.file.path}" data-id="${n.file.name}" onclick=\"viewFile(this)\" class="btn mb-1 waves-effect waves-light ativ" type="button" name="action" style=" width: 15px;padding: 1;padding-right: 8px; background-color: #f5bd46da;"><i class="material-icons right">cloud_download</i></button>
                     </td>
                  </tr>
               `;
            });
            $("#tb_append_finalizado").html(ap);

            var ap = "";
            var historyResponse = re["message"]["history"];
            $.map(historyResponse, function(n, i) {
                ap += `
                  <li class="timeline-items timeline-icon-green active">
                     <div id="data_f" class="timeline-time">${n.data_operacao}</div>
                     <h5 id="name_u" class="timeline-title">${n.nome_user}</h5>
                     <p id="action_f" class="timeline-text">${n.descricao}</p>
                  </li>
               `;
            });
            $("#historico_F").html(ap);

        }

    });

}

$('#btn_card_coletaF').on("click", function() {
    var a = $("#btn_card_coletaF");
    a.next('#card_coletaF').slideToggle();

});


</script>
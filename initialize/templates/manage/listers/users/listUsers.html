{% extends 'base.html' %}
{% load static %}
{% block title %}Shiloh | Listar Usuários Internos{% endblock %}
{% block icon-page %}
metismenu-icon lnr-apartment icon-gradient bg-sunny-morning
{% endblock %}
{% block title-page %}
Página inicial
{% endblock %}
{% block description-page %}
Acompanhe as últimas notícias!
{% endblock %}

{% block content %}

<style type="text/css">
   .corfont{
   color: #641108;
   font-weight: bold;
   }

</style>

<!-- INICIO DO MODAL -->
<div id="modal1" class="modal modal-fixed-footer" style="width: 85%; height: 90%;max-height: 85%">
   <div class="modal-content" id="modal2">
      <div class="breadcrumbs-dark pb-0" id="breadcrumbs-wrapper">
         <div class="container">
            <div class="card">
               <div class="card-content" style="margin-top: -40px; background-color: #581848;">
                  <h5 class="corfont" style="color: white;">ATUALIZAR USUÁRIO</h5>
               </div>
            </div>
         </div>
         <div class="container">
            <div class="card" id="modalint">
               <div class="input-field col s3" >
                  <label for="tp_perfil" style="margin-bottom: 15px;">Perfil</label>
                  <div class="select-wrapper" style="margin-top: 30px;">                     
                     <input readonly="readonly" style="color:black" id="tp_perfil" type="text">                     
                  </div>
               </div>
               <div class="input-field col s3" >
                  <label for="unity" style="margin-bottom: 15px;">Unidade</label>
                  <div class="select-wrapper" style="margin-top: 30px;">
                     <select name="select" id="unity" class="error " required="true">
                        <option value="">Selecione</option>
                        {% for k in arr_SearchUnit %}
                        <option value="{{ k.id_unit_s }}">{{ k.unit_s }}</option>
                        {% endfor %}
                     </select>
                  </div>
               </div>
               <!-- Interno -->
               <div id="userint" class="row" >
                  <div class="col s12">
                     <div class="input-field col s3">
                        <input id="cpf" type="text" >
                        <label for="cpf">
                        <i class="material-icons" style="font-size: 15px">featured_play_list</i>&nbsp;CPF</label>
                     </div>
                     <div class="input-field col s5">
                        <input id="name" type="text">
                        <label for="name">
                        <i class="material-icons" style="font-size: 15px">person</i>&nbsp;Nome</label>
                     </div>
                     <div class="input-field col s4">
                        <input id="date_nasc" type="date" >
                        <label for="date_nasc">Data de Nacimento</label>
                     </div>
                  </div>
                  <div class="col s12">
                     <div class="input-field col s8">
                        <input id="email" type="email" >
                        <label for="email">
                        <i class="material-icons" style="font-size: 15px">email</i>&nbsp;E-mail</label>
                     </div>
                     <div class="input-field col s2">
                        <input id="tel1" type="tel" >
                        <label for="tel1">
                        <i class="material-icons" style="font-size: 15px">phone</i>&nbsp;Telefone 1</label>
                     </div>
                     <div class="input-field col s2">
                        <input id="tel2" type="tel" >
                        <label for="tel2">
                        <i class="material-icons" style="font-size: 15px">phone</i>&nbsp;Telefone 2</label>
                     </div>
                  </div>
                  <div class="col s12">
                     <div class="input-field col s3">
                        <input id="zipcode" type="text"  maxlength="9" onblur="pesquisacep(this.value)">
                        <label for="zipcode">
                        <i class="material-icons" style="font-size: 15px">place</i>&nbsp;CEP </label>
                     </div>
                     <div class="input-field col s7">
                        <input id="addres" type="text" >
                        <label for="addres">Logradouro </label>
                     </div>
                     <div class="input-field col s2">
                        <input id="number" type="text" >
                        <label for="number">Número </label>
                     </div>
                  </div>
                  <div class="col s12">
                     <div class="input-field col s3">
                        <input id="complement" type="text" >
                        <label for="complement">Complemento</label>
                     </div>
                     <div class="input-field col s5">
                        <input id="district" type="text" >
                        <label for="district">Bairro</label>
                     </div>
                     <div class="input-field col s2">
                        <input id="city" type="text" >
                        <label for="city">Cidade</label>
                     </div>
                     <div class="input-field col s2">
                        <input id="uf" type="text"  maxlength="2">
                        <label for="uf">UF</label>
                     </div>
                  </div>
               </div>
            </div>
         </div>
         <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.maskedinput/1.3.1/jquery.maskedinput.min.js"></script>  
         <script type="text/javascript">
            $("#cpf").mask("999.999.999-99");  
            $("#tel1").mask("(99) 99999-9999");
            $("#tel2").mask("(99) 99999-9999");
               $("#zipcode").mask("99999-999");
            
            
            // CEP 
            function pesquisacep(valor) {
            var cep = valor.replace(/\D/g, '');
            
            if (cep != "") {
               var validacep = /^[0-9]{8}$/;
               if(validacep.test(cep)) {
                  var end_addres = $("#addres").val("...");
                  var end_district = $("#district").val("...");
                  var end_city = $("#city").val("...");
                  var end_state = $("#uf").val("...");
                  var script = document.createElement('script');
            
                  script.src = 'https://viacep.com.br/ws/'+ cep + '/json/?callback=bsccep';
                  document.body.appendChild(script);
               } 
               else {
                  limocamp();
                  alert("Formato de CEP inválido.");
               }
            }
            else {
               limocamp();
            }
            };
            
            function bsccep(val) {
            if (!("erro" in val)) {
               var end_addres = $("#addres").val(val.logradouro);
               var end_district = $("#district").val(val.bairro);
               var end_city = $("#city").val(val.localidade);
               var end_state = $("#uf").val(val.uf);
            } 
            else {
               limocamp();
               alert("CEP não encontrado no CORREIOS. Entre no site: https://www.correios.com.br/ e pesquise um cep válido.");
            }
            }
            
            function limocamp() {
            var end_zipcode = $("#zipcode").val("");
            var end_addres = $("#addres").val("");
            var end_number = $("#number").val("");
            var end_district = $("#district").val("");
            var end_city = $("#city").val("");
            var end_state = $("#uf").val("");
            }
            
            
            
            
            
         </script>
      </div>
   </div>
   <div class="modal-footer">
      <!--BUTTON-->
      <div class="col s12 ">
         <div class="col s12 m12 m12">
            <a onclick="changeUserModal(this)" id="btn_atualizar" data-target="#CompanyProfile" class="waves-effect waves-light btn mb-1 mr-1">Atualizar</a>      
            <a class="waves-effect waves-light btn mb-1 mr-1 modal-action modal-close waves-effect" style="background-color: #eee"><span style="color:#212529; font-size: 16px; font-weight: bold;">VOLTAR</span></a>
         </div>
      </div>
   </div>
</div>
<div class="breadcrumbs-dark pb-0" id="breadcrumbs-wrapper">
<!--FIM DO MODAL-->

<div class="breadcrumbs-dark pb-0" id="breadcrumbs-wrapper">
<div class="container">
   <div class="card" >
      <div class="card-content" style="margin-top: -93px;">
         <h5 class="corfont">USUÁRIOS INTERNOS</h5>
      </div>
   </div>
</div>

<div class="container">
   <div class="card" >
      <!-- Externo -->
      <div  class="row" >
         <div class="col s12"  style="margin-top: 30px; margin-bottom: 30px;">
            <div class="input-field col m5 s12">
               <input id="bscinput" type="text" onkeyup="SearchUsers(this)">
               <label for="bscinput">
               <i class="material-icons" style="font-size: 15px">person</i>&nbsp;Buscar por nome...</label>    
            </div>
            <div class="input-field col s4" >
               <div class="select-wrapper">
                  <select name="select" id="tp_user" class="error">
                     <option value="">Selecione</option>
                     {% for k in arr_SearchPerfil %}
                     <option value="{{k.id}}">{{k.descriptions}}</option>
                     {% endfor %}
                  </select>
               </div>
            </div>
            <div class="input-field col s3">
               <div class="col s12 mb-2">
                  <button onclick="PesquisarFilter()" id="btn_pesquisar" class="waves-effect waves dark btn next-step" type="submit" style="width: 100%; margin-top: 10px">
                  <span style="font-weight: bold; color: white; font-family:Verdana, Geneva, Tahoma, sans-serif">Pesquisar</spanpx>
                  </button>
               </div>
            </div>
            <!--BUTTON-->
            <div class="col s12 ">
            </div>
            <!-- COMEÇO DA TABLE -->
            <div class="col s12">
               <table id="page-length-option" class="bordered" style="margin-top: 40px; overflow-x: auto">
                  <thead style="background-color: #581848; color: white; font-size: 15px" >
                     <tr>
                        <th data-field="id" >Nome do Usuário</th>
                        <th data-field="id" style="text-align: center; width: 130px;">Perfil</th>
                        <th data-field="id" style="text-align: center; width: 130px;">Unidade</th>
                        <th data-field="id" style="text-align: center; width: 130px;">Status</th>
                        <th data-field="name" style="text-align: center; width: 130px;">Ação</th>
                     </tr>
                  </thead>
                  <tbody id="tb_append">
                     {% for k in arr_SearchUsersFull %} <!-- ARRAY COM AS INFORMAÇÕES DA TABELA    -->
                     <tr id="tr_{{ k.id }}">
                        <td>{{ k.nome }}</td>
                        <td style="text-align: center;">{{ k.descriptions }}</td>
                        <td style="text-align: center;">{{ k.unity }}</td>
                        <td style="text-align: center;">{{ k.status }}</td>
                        <td style="text-align: center;">
                           <a href="#modal1" class="modal-trigger" data-id_user="{{ k.id }}" onclick="viewUserModal(this)">
                              <!-- data-id_user="{{ k.id }}  É TRATADO COMO SE FOSSE UMA VAR DENTRO-->
                              <button class="btn mb-1 waves-effect waves-light ativ" type="submit" name="action" style="margin-left: 5px; width: 15px;padding: 1;padding-right: 8px; background-color: #f5bd46da;">
                              <i class="material-icons right">edit</i>
                              </button>
                           </a>
                           <button id="btn_status_{{ k.id }}" onclick="changeStatusUser(this)" data-id_user="{{ k.id }}" class="btn mb-1 waves-effect " type="button" name="action" style=" margin-left: 5px; width: 15px;padding: 1;padding-right: 8px; background-color: {{ k.btn_status }};">
                           <i class="material-icons right">check</i>
                           </button>
                        </td>
                     </tr>
                     {% endfor %} <!-- FIM DO ARRAY -->
                  </tbody>
               </table>
            </div>
            <!-- FIM DA TABLE -->
         </div>
      </div>
   </div>
</div>

<script type = "text/javascript" >
   function SearchUsers(object) {
      var e = $(object).val().toUpperCase();
      if (e == "") {
         $('#tb_append > tr').each(function () {
            $(this).show();
         });
      } else {
         $('#tb_append > tr').each(function () {
            var trs = $(this).find("td");
            var tr1 = $(trs[0]).text().toUpperCase();
            var check = (tr1.indexOf(e) != -1);
            if (check == true) {
               $(this).show();
            } else {
               $(this).hide();
            }
         });
      }
   }
$("#btn_pesquisar").click(function () {
   PesquisarFilter();
});

$(document).ready(function () {
   $('.modal').modal();
   $('.modal').css({
      "width": "80%",
   });
});

function PesquisarFilter() {

   var Stp_perfil = $("#tp_user").val();
   var formpost = {
      "csrfmiddlewaretoken": $('input[name="csrfmiddlewaretoken"]').val(),
      "Stp_perfil": Stp_perfil,
   };
   fetchRequest("{% url 'ApiListUsers' %}", "POST", "JSON", formpost, function (re) {
      (dados = re["message"])
      var exibir = $("#tb_append").html(" ");
      for (k in dados) {
         var key = dados[k];
         var append = '<tr id="tr_' + key["id"] + '"> <td> ' + key["nome"] + ' </td> <td style="text-align: center;"> ' + key["descriptions"] + ' </td> <td style="text-align: center;"> ' + key["unity"] + ' </td> <td style="text-align: center;"> ' + key["status"] + ' </td> <td style="text-align: center;"> <a href="#modal1" class="modal-trigger" > <button onclick=\"viewUserModal(this)\" data-id_user="' + key["id"] + '" class="btn mb-1 waves-effect waves-light ativ" type="submit" name="action" style="margin-left: 5px; width: 15px;padding: 1;padding-right: 8px; background-color: #f5bd46da;"> <i class="material-icons right">edit</i> </button></a> <button id="btn_status_' + key["id"] + '" onclick=\"changeStatusUser(this)\" data-id_user="' + key["id"] + '" class="btn mb-1 waves-effect " type="button" name="action" style=" margin-left: 5px; width: 15px;padding: 1;padding-right: 8px; background-color: ' + key["btn_status"] + ';"><i class="material-icons right">check</i> </button> </td> </tr>'
         $("#tb_append").append(append); //FAZ O APPEND DENTRO DA TABELA


      }
      if (dados == "") { // SE O RETORNO DA PESQUISA ESTIVER VAZIO, RETORNA NENHUMA INFORMAÇÃO
         var appende = '<td colspan="5" style="text-align: center; background: #ededeb">Nenhum Registro Encontrado</td>'
         $("#tb_append").append(appende);
      }
   });

}


function viewUserModal(object) { //FUNCTION DO ONCLICK
   var id_user = $(object).data("id_user"); //objeto usuario que compoe um data-id_user
   $("#btn_atualizar").data("id_user", id_user); // para ter o data, precisa conter os seguintes parametros: elemento, key, value

   $("#modal2").hide();
   $(object).prop("disabled", true);
   var formpost = {
      "csrfmiddlewaretoken": $('input[name="csrfmiddlewaretoken"]').val(),
      "id_user": id_user //DICT COM O VALOR DO ID
   };

   fetchRequest("{% url 'ApiViewDataUserModal' %}", "POST", "JSON", formpost, function (re) { // A URL É COMPOSTA PELO NAME DE UMA URL
      if (re["response"] == false) {
         alert("Nenhum dado encontrado."); // VERIFICA SE A INFO É VÁLIDA, SE NÃO, MESSAGE
      } else { //SE FOR VERDADDEIRA, PROSSEGUE
         $("#modal2").show();
         var key = re["message"]; // NO DECORATOR, A MENSAGEM RETORNA O VALOR DO DICT, NESSE CASO É DECLARADO EM UM DICT: "id_campo" : key[valor-do-grupo][valor-do-key]
         var dictKeys = {
            "unity": key["unity"],
            "tp_perfil": key["perfil"],
            "cpf": key["personal"]["cpfcnpj"],
            "name": key["personal"]["name"],
            "date_nasc": key["personal"]["birthday"],
            "email": key["contacts"]["email"],
            "tel1": key["contacts"]["phone"],
            "tel2": key["contacts"]["phone_aux"],
            "zipcode": key["address"]["zipcode"],
            "addres": key["address"]["street"],
            "number": key["address"]["street_number"],
            "complement": key["address"]["complement"],
            "district": key["address"]["district"],
            "city": key["address"]["city"],
            "uf": key["address"]["state"],
         };
         $.map(dictKeys, function (n, i) { // map é usado para traduzir ou mapear os elementos de um array para outro conjunto de valores
            $(`#${i}`).val(n); // n simboliza o valor e i simboliza a key
            var findLabel = $(`#${i}`).closest("div"); // essa variavel serve para procurar um valor e atribuir o módulo closest div
            $(findLabel).find("label").attr("class", "active"); //serve para encontrar dentro do closest div uma label e atribuir o módulo attr(atributo, valor)
            if (i == "unity") { //GAMBIARRA PARA INPUTAR O SELECT
               var valueObject = $("#unity option:selected").text();
               $("input[class='select-dropdown dropdown-trigger']").val(valueObject);
               $('li[class="selected"]').attr("class", "");
               var findObject = $(`span:contains(${valueObject})`).closest("li");
               $(findObject).attr("class", "selected");
            }
         });
         $("#btn_atualizar").data("id_user", key["id"]); //ATRIBUI UM NOVO VALOR PARA O ID
      }
   });
}

function changeStatusUser(object) {
   var id_user = $(object).data("id_user"); //objeto usuario que compoe um data-id_user
   var formpost = {
      "csrfmiddlewaretoken": $('input[name="csrfmiddlewaretoken"]').val(),
      "id_user": id_user //DICT COM O VALOR DO ID
   };

   fetchRequest("{% url 'ApiChangeStatus' %}", "POST", "JSON", formpost, function (re) { // A URL É COMPOSTA PELO NAME DE UMA URL
      if (re["response"] == false) {
         alert("Nenhum dado encontrado."); // VERIFICA SE A INFO É VÁLIDA, SE NÃO, MESSAGE
      } else { //SE FOR VERDADDEIRA, PROSSEGUE
         var key = re["message"]; // NO DECORATOR, A MENSAGEM RETORNA O VALOR DO DICT, NESSE CASO É DECLARADO EM UM DICT: "id_campo" : key[valor-do-grupo][valor-do-key]
         $(`#tr_${id_user} > td`).eq(3).text(key["status"]);
         $(`#btn_status_${id_user}`).css("background-color", key["btn_status"])
      }
   });
}


function changeUserModal(object) {
   email = $("#email").val()

   //VALIDAÇÃO DO EMAIL
   var filter = /^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,})+$/;
   if (!filter.test(email) && email != "") {
      alert('Insira um e-mail válido.');
      return false;
   }


   //VALIDAÇÃO DE CAMPO NULL
   if ("#unity" == "") {
      alert("Selecione uma unidade válida.")
      return false
   } else {

      $("#btn_atualizar").attr("disabled", true);
      var padrao = "R$ 400,00"
      var porcentagem = 0
      var fixo = 0

      perfil = $("#tp_perfil").val()

      var id_user = $(object).data("id_user"); //objeto usuario que compoe um data-id_user
      var formpost = {
         "csrfmiddlewaretoken": $('input[name="csrfmiddlewaretoken"]').val(),
         "id_user": id_user, //DICT COM O VALOR DO ID
         "padrao": padrao,
         "porcentagem": porcentagem,
         "fixo": fixo,
         "perfil": perfil,
      };

      $("#modalint input, #modalint select").each(function () { // PROCCURA O QUE ESTÁ PREENCHIDO E SELECIONADO E ATRAVER DO FORMPOST PEGA O VALOR E MANDA PARA O BACK
         formpost[$(this).attr("id")] = $(this).val();
      });
      fetchRequest("{% url 'ApiChangeUsersModal' %}", "POST", "JSON", formpost, function (re) { // A URL É COMPOSTA PELO NAME DE UMA URL
         if (re["response"] != true) {
            alert("Nenhum dado encontrado."); // VERIFICA SE A INFO É VÁLIDA, SE NÃO, MESSAGE
         } else { //SE FOR VERDADDEIRA, PROSSEGUE
            alert(re["message"]);
            location.reload();

         }
      });
   }
} 
</script>

{% endblock %}
{% extends 'base.html' %}
{% load static %}
{% block title %}Shiloh | Cadastrar Usuário{% endblock %}
{% block icon-page %}
metismenu-icon lnr-apartment icon-gradient bg-sunny-morning
{% endblock %}
{% block title-page %}
Cadastrar Usuário
{% endblock %}
{% block description-page %}
CADASTRAR USUÁRIOS{% endblock %}
{% block content %}
<form method="POST" action="">{% csrf_token %}</form>

<div class="breadcrumbs-dark pb-0 " >
   <div class="container">
      <div class="card">
         <div class="row">
            <div class="container">
               <div class="col s12 m12 m-b10" style="padding-left: 10px;">
                  <div class="active">
                     <div class="collapsible-header col m6 s12 " style="height: 40px; margin-top: 10px; background-color: #581848; color: white;" tabindex="0">
                        <label style="margin-top: 0.2em; font-size: 20px; font-weight: bold;">Selecione:</label>
                     </div>
                  </div>
               </div>
               <div class=" col s3 m2 mb-5" style="margin-top: 30px;">
                  <label>
                  <input id="shiloh_lab" value="1" class="with-gap" type="radio" name="option"/>
                  <span style="padding-left: 25px;">ShilohLab</span>
                  </label>
               </div>
               <div class="container col s3 m2 " style="margin-top: 30px;">
                  <label>
                  <input id="lab_movel" value="2" class="with-gap" type="radio" name="option" />
                  <span style="padding-left: 25px;">LabMovel</span>
                  </label>
               </div>
               <div class="container col s3 m2 " style="margin-top: 30px;">
                  <label>
                     <input id="goshen_lab" value="3" class="with-gap" type="radio" name="option" />
                     <span style="padding-left: 25px;">Goshen Lab</span>
                  </label> 
               </div>
            </div>
         </div>
         <div class="container" id="userint" style="display:none">
            <div class="input-field col m3 s12" >
               <label style="margin-bottom: 15px;">Perfil <span style="color: red;">*</span></label>
               <div class="select-wrapper" style="margin-top: 30px;">
                  <select name="select" id="tp_perfil" class="error " data-required="true">
                     <option value="">Selecione</option>
                     {% for k in arr_SearchPerfil %}
                     <option value="{{ k.id }}">{{ k.descriptions }}</option>
                     {% endfor %}
                  </select>
               </div>
            </div>
            <div class="input-field col m3 s12" >
               <label style="margin-bottom: 15px;">Unidade <span style="color: red;">*</span></label>
               <div class="select-wrapper" style="margin-top: 30px;">
                  <select name="select" id="unit" data-required="true">
                     <option value="">Selecione</option>
                     {% for k in arr_SearchUnit %}
                     <option value="{{ k.id_unit_s }}">{{ k.unit_s }}</option>
                     {% endfor %}
                  </select>
               </div>
            </div> 
            <!-- Interno -->
            <div  class="row" >
               <div class="col m12 s12">
                  <div class="input-field col m3 s12">
                     <input id="cpf" type="text"  data-required="true">
                     <label for="cpf">
                     <i class="material-icons" style="font-size: 15px">featured_play_list</i>&nbsp;CPF <span style="color: red;">*</span></label>
                  </div>
                  <div class="input-field col m5 s12">
                     <input id="name" type="text"  data-required="true" class="upper">
                     <label for="name">
                     <i class="material-icons" onkeyup="formatText()" style="font-size: 15px">person</i>&nbsp;Nome <span style="color: red;">*</span></label>
                  </div>
                  <div class="input-field col m4 s12">
                     <input id="date_nasc" type="date"  data-required="true">
                     <label for="date_nasc">Data de Nacimento <span style="color: red;">*</span></label>
                  </div>
               </div>
               <div class="col m12 s12">
                  <div class="input-field col m8 s12">
                     <input id="email" type="email"  data-required="true">
                     <label for="email">
                     <i class="material-icons" style="font-size: 15px">email <span style="color: red;">*</span></i>&nbsp;E-mail</label>
                  </div>
                  <div class="input-field col m2 s12">
                     <input id="tel1" type="tel"  data-required="true">
                     <label for="tel1">
                     <i class="material-icons" style="font-size: 15px">phone</i>&nbsp;Telefone 1 <span style="color: red;">*</span></label>
                  </div>
                  <div class="input-field col m2 s12">
                     <input id="tel2" type="tel">
                     <label for="tel2">
                     <i class="material-icons" style="font-size: 15px">phone</i>&nbsp;Telefone 2</label>
                  </div>
               </div>
               <div class="col m12">
                  <div class="input-field col m3 s12" >
                     <input id="zipcode" type="text"  maxlength="9" onblur="pesquisacep(this.value)"  data-required="true">
                     <label for="zipcode">
                     <i class="material-icons" style="font-size: 15px">place</i>&nbsp;CEP <span style="color: red;">*</span></label>
                  </div>
                  <div class="input-field col m7 s12">
                     <input id="addres" type="text" data-required="true" >
                     <label for="addres">Logradouro </label>
                  </div>
                  <div class="input-field col m2 s12">
                     <input id="number" type="text" data-required="true" >
                     <label for="number">Número </label>
                  </div>
               </div>
               <div class="col m12">
                  <div class="input-field col m3 s12">
                     <input id="complement" type="text" >
                     <label for="complement">Complemento</label>
                  </div>
                  <div class="input-field col m5 s12">
                     <input id="district" type="text" data-required="true" >
                     <label for="district">Bairro</label>
                  </div>
                  <div class="input-field col m2 s12">
                     <input id="city" type="text" data-required="true" >
                     <label for="city">Cidade</label>
                  </div>
                  <div class="input-field col m2 s12">
                     <input id="uf" type="text"  maxlength="2" data-required="true">
                     <label for="uf">UF</label>
                  </div>
               </div>
               <!--BUTTON-->
               <div class="col m12 s12">
                  <div class="col m12 s12 mb-2">
                     <button id="btn_cadastrar" class="waves-effect waves dark btn next-step" type="submit" style="width: 100%; margin-top: 10px" onclick="CadastreUser()">
                     <span style="font-weight: bold; color: white; font-family:Verdana, Geneva, Tahoma, sans-serif">Cadastrar</spanpx>
                     </button>
                  </div>
               </div>
            </div>
         </div>
      </div>
      
   </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.maskedinput/1.3.1/jquery.maskedinput.min.js"></script>
<script type = "text/javascript">
   
   //APARECE CARD
   $(".with-gap").click(function() {
      $("#userint").show();
   });

   $("#cpf").mask("999.999.999-99");
   $("#tel1").mask("(99) 99999-9999");
   $("#tel2").mask("(99) 99999-9999");
   $("#zipcode").mask("99999-999");

   function CadastreUser() {
      $("#btn_cadastrar").attr("disabled", true);

      var tp_perfil = $("#tp_perfil").val();
      var cpf = $("#cpf").val();
      var name = $("#name").val();
      var date_nasc = $("#date_nasc").val();
      var email = $("#email").val();
      var tel1 = $("#tel1").val();
      var tel2 = $("#tel2").val();
      var zipcode = $("#zipcode").val();
      var addres = $("#addres").val();
      var number = $("#number").val();
      var complement = $("#complement").val();
      var district = $("#district").val();
      var city = $("#city").val();
      var uf = $("#uf").val();
      var unit = $("#unit").val();
      var shiloh = $('#shiloh_lab').val();
      var movel = $('#lab_movel').val(); 
      var goshen = $('#goshen_lab').val(); 
      
      var shiloh = $("#shiloh_lab").prop("checked")
      var movel = $("#lab_movel").prop("checked")
      var goshen = $("#goshen_lab").prop("checked")

       //VALIDAÇÃO DO EMAIL
       var filter = /^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,})+$/;
         if(!filter.test(email) && email != ""){
            alert('Insira um e-mail válido.');  
            return false;
         }


      //VALIDAÇÃO DE CAMPO NULL
      var i = 0;
      $("#userint input[data-required='true'], select[data-required='true']").each(function () {
         if ($(this).val() == "") {
            alert("Preencha os campos obrigatórios.");
            $(this).focus();
            $("#btn_cadastrar").attr("disabled", false);
            i = 1;
            return false;
         }
      });
      if (i == 1) {
         return false;
      }

      shiloh = $("#shiloh_lab").prop("checked")
      movel = $("#lab_movel").prop("checked")
      goshen = $("#goshen_lab").prop("checked")

      if (shiloh){
         empresa = $("#shiloh_lab").val()
      }else if (movel){
         empresa = $("#lab_movel").val()
      }else{
         empresa = $("#goshen_lab").val()
      }

      var btncadastrar = {
         "csrfmiddlewaretoken": $('input[name="csrfmiddlewaretoken"]').val(),
         "tp_perfil": $('#tp_perfil').val(),
         "cpf": $('#cpf').val(),
         "name": $('#name').val(),
         "date_nasc": $('#date_nasc').val(),
         "email": $('#email').val(),
         "tel1": $('#tel1').val(),
         "tel2": $('#tel2').val(),
         "zipcode": $('#zipcode').val(),
         "addres": $('#addres').val(),
         "number": $('#number').val(),
         "complement": $('#complement').val(),
         "district": $('#district').val(),
         "city": $('#city').val(),
         "uf": $('#uf').val(),
         "unit": $('#unit').val(),
         "empresa": empresa,
      };

      fetchRequest("{% url 'ApiCadastreUser' %}", "POST", "JSON", btncadastrar, function (re) {
         if (re["response"] == true) {
            alert(re["message"]);
            location.reload();
         }else{
            alert(re["message"]);
            $("#btn_cadastrar").attr("disabled", false);
         }
      });
   };


   // CEP 
   function pesquisacep(valor) {
      var cep = valor.replace(/\D/g, '');

      if (cep != "") {
         var validacep = /^[0-9]{8}$/;
         if (validacep.test(cep)) {
            var end_addres = $("#addres").val("...");
            var end_district = $("#district").val("...");
            var end_city = $("#city").val("...");
            var end_state = $("#uf").val("...");
            var script = document.createElement('script');

            script.src = 'https://viacep.com.br/ws/' + cep + '/json/?callback=bsccep';
            document.body.appendChild(script);
         } else {
            limocamp();
            alert("Formato de CEP inválido.");
         }
      } else {
         limocamp();
      }
   };

   function bsccep(val) {
      if (!("erro" in val)) {
         var end_addres = $("#addres").val(val.logradouro);
         var end_district = $("#district").val(val.bairro);
         var end_city = $("#city").val(val.localidade);
         var end_state = $("#uf").val(val.uf);
      } else {
         limocamp();
         alert("CEP não encontrado no CORREIOS. Entre no site: https://www.correios.com.br/ e pesquise um cep válido.");
      }
   }

   function limocamp() {
      var end_zipcode = $("#zipcode").val("");
      var end_addres = $("#addres").val("");
      var end_number = $("#number").val("");
      var end_district = $("#district").val("");
      var end_city = $("#city").val("");
      var end_state = $("#uf").val("");
   }

</script>
{% endblock %}